# JDBC Proxy 使用文档

## 概述

JDBC Proxy 是一个客户端-服务器模式的数据库代理系统，支持密态数据库的存储与加密。服务器监听指定端口，拦截客户端发来的SQL语句，进行改写后与真实数据库通信，最后返回结果给客户端。

## 系统架构

```
客户端应用 → JDBC Proxy 客户端 → JDBC Proxy 服务器 → 真实数据库
```

## 部署要求

### 环境要求
- Java 8 或更高版本
- MySQL 数据库
- 网络连接（客户端到服务器，服务器到数据库）

### 文件清单
- `jdbc-proxy-core-0.2.0-SNAPSHOT-jar-with-dependencies.jar` - 服务器端
- `jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar` - 客户端测试工具

## 启动服务

### 1. 启动代理服务器

```bash
# 使用默认端口 9999
java -Dport=9999 -jar jdbc-proxy-core-0.2.0-SNAPSHOT-jar-with-dependencies.jar

# 使用自定义端口
java -Dport=8888 -jar jdbc-proxy-core-0.2.0-SNAPSHOT-jar-with-dependencies.jar
```

启动成功后，服务器会显示：
```
JDBC Proxy Server starting...
Server listening on port 9999
```

### 2. 验证服务器状态

服务器启动后会自动：
- 创建线程池处理客户端连接
- 启动超时检测和资源清理任务
- 监听指定端口的客户端连接

## 五种功能使用指南

### 功能一：普通查询 (SELECT)

**用途**：执行无条件的全表查询

**命令格式**：
```bash
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=select [参数]
```

**参数说明**：
- `select.columns` - 指定查询的列（默认：id,test）
- `table.name` - 指定表名（默认：my_table）

**使用示例**：
```bash
# 基本查询
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=select

# 指定列查询
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=select select.columns=id,name,age

# 指定表查询
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=select table.name=users select.columns=id,username
```

**输出示例**：
```
[查询] SQL: SELECT id,test FROM my_table
[查询结果] id=1 test=default
[查询结果] id=2 test=test_value
```

### 功能二：等值查询 (Equivalent SELECT)

**用途**：根据指定条件查询匹配的记录（支持加密字段查询）

**命令格式**：
```bash
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=equivalent_select [参数]
```

**参数说明**：
- `search.value` - 搜索值（默认：default_value）
- `select.columns` - 指定查询的列（默认：id,test）
- `table.name` - 指定表名（默认：my_table）
- `equivalent_select.condition_column` - 条件列名（默认：test）

**使用示例**：
```bash
# 基本等值查询
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=equivalent_select

# 指定搜索值
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=equivalent_select search.value="test_value"

# 指定条件列和搜索值
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=equivalent_select search.value="admin" equivalent_select.condition_column=username

# 指定查询列
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=equivalent_select search.value="test" select.columns=id,test,created_time
```

**输出示例**：
```
[等效查询] SQL: SELECT id,test FROM my_table WHERE test = ?
[等效查询] 搜索值: test_value
[等效查询] 参数已设置: 1 = test_value
[查询结果] 第1行: id=2 test=test_value
[等效查询] 总共返回 1 行数据
```

### 功能三：插入操作 (INSERT)

**用途**：向指定表插入新记录

**命令格式**：
```bash
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=insert [参数]
```

**参数说明**：
- `insert.value` - 插入的值（默认：test）
- `insert.column` - 插入的列名（默认：test）
- `table.name` - 指定表名（默认：my_table）

**使用示例**：
```bash
# 基本插入
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=insert

# 指定插入值
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=insert insert.value="new_record"

# 指定列和值
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=insert insert.column=name insert.value="John Doe"

# 指定表
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=insert table.name=users insert.column=username insert.value="john_doe"
```

**输出示例**：
```
[Insert] SQL: INSERT INTO my_table (test) VALUES (?)
[Insert] 插入值: new_record
[Insert] 影响行数: 1
```

### 功能四：更新操作 (UPDATE)

**用途**：更新指定条件的记录

**命令格式**：
```bash
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=update [参数]
```

**参数说明**：
- `update.value` - 新的值（默认：default_value）
- `update.condition_value` - 条件值（默认：1）
- `update.target_column` - 目标列名（默认：test）
- `update.condition_column` - 条件列名（默认：id）
- `table.name` - 指定表名（默认：my_table）

**使用示例**：
```bash
# 基本更新
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=update

# 指定新值和条件
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=update update.value="updated_value" update.condition_value=1

# 指定目标列和条件列
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=update update.target_column=status update.condition_column=id update.value="active" update.condition_value=2

# 指定表
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=update table.name=users update.target_column=email update.condition_column=id update.value="new@email.com" update.condition_value=1
```

**输出示例**：
```
[Update] SQL: UPDATE my_table SET test = ? WHERE id = ?
[Update] 新值: updated_value, 条件值: 1
[Update] 影响行数: 1
```

### 功能五：删除操作 (DELETE)

**用途**：删除指定条件的记录

**命令格式**：
```bash
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=delete [参数]
```

**参数说明**：
- `delete.condition_value` - 条件值（默认：default_value）
- `delete.condition_column` - 条件列名（默认：test）
- `table.name` - 指定表名（默认：my_table）

**使用示例**：
```bash
# 基本删除
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=delete

# 指定条件值
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=delete delete.condition_value="test_value"

# 指定条件列
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=delete delete.condition_column=id delete.condition_value=1

# 指定表
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=delete table.name=users delete.condition_column=username delete.condition_value="john_doe"
```

**输出示例**：
```
[Delete] SQL: DELETE FROM my_table WHERE test = ?
[Delete] 条件值: test_value
[Delete] 影响行数: 1
```

## 高级功能

### 额外查询功能

在普通查询基础上，可以添加额外查询功能，支持跨数据库查询：

```bash
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=select select.columns=id,test extra.enabled=true extra.table=test_cmd extra.columns=no,entest extra.db.url=jdbc:mysql://localhost:3306/test_enc
```

**参数说明**：
- `extra.enabled` - 启用额外查询（true/false）
- `extra.table` - 额外查询的表名
- `extra.columns` - 额外查询的列名
- `extra.db.url` - 额外查询的数据库连接URL

**使用场景**：
1. **正常情况**：主表在主数据库，副表在额外数据库
   ```bash
   java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=select select.columns=id,test extra.enabled=true extra.table=test_cmd extra.columns=no,entest extra.db.url=jdbc:mysql://localhost:3306/test_enc
   ```

2. **调换主副表**：主表在额外数据库，副表在主数据库
   ```bash
   java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=select table.name=test_cmd db.realUrl=jdbc:mysql://localhost:3306/test_enc select.columns=no,entest extra.enabled=true extra.table=my_table extra.columns=id,test extra.db.url=jdbc:mysql://localhost:3306/test_mysql
   ```

**注意事项**：
- 额外查询功能支持跨数据库操作
- 必须指定 `extra.db.url` 参数来指定额外数据库的连接地址
- 主查询和额外查询可以分别在不同的数据库中执行

### 自定义数据库连接

可以通过命令行参数覆盖默认的数据库连接配置：

```bash
java -jar jdbc-proxy-tester-0.2.0-SNAPSHOT-jar-with-dependencies.jar operation=select db.realUrl=jdbc:mysql://localhost:3306/mydb db.user=myuser db.password=mypassword
```

## 配置说明

### 默认配置文件

客户端jar包内包含 `config.properties` 配置文件，包含以下默认配置：

```properties
# 数据库连接配置
db.realUrl=jdbc:mysql://localhost:3306/test_mysql
db.user=root
db.password=200261

# 表配置
table.name=my_table
select.columns=id,test

# 插入配置
insert.column=test
insert.value=default

# 更新配置
update.condition_column=id
update.target_column=test
update.value=default
update.condition_value=1

# 删除配置
delete.condition_column=test
delete.condition_value=test

# 等值查询配置
equivalent_select.condition_column=test
search.value=default
```

### 配置优先级

1. 命令行参数（最高优先级）
2. 配置文件中的设置
3. 代码中的默认值（最低优先级）

## 错误处理

### 常见错误及解决方案

1. **连接失败**
   ```
   java.sql.SQLException: Failed to create proxy connection
   ```
   - 检查服务器是否启动
   - 确认端口是否正确
   - 检查网络连接

2. **数据库连接错误**
   ```
   java.sql.SQLException: Communications link failure
   ```
   - 检查数据库服务是否运行
   - 确认数据库连接信息
   - 检查防火墙设置

3. **参数错误**
   ```
   java.lang.RuntimeException: 操作执行失败: No value specified for parameter 1
   ```
   - 检查SQL语句是否正确
   - 确认参数是否完整设置

4. **表不存在**
   ```
   java.sql.SQLException: Table 'database.table' doesn't exist
   ```
   - 确认表名是否正确
   - 检查数据库权限

## 日志说明

### 服务器端日志

- `Server listening on port XXXX` - 服务器启动成功
- `New client connected` - 新客户端连接
- `Dispatching request: XXX` - 处理请求类型
- `Connection XXX closed successfully` - 连接关闭

### 客户端日志

- `[查询] SQL: XXX` - 执行的SQL语句
- `[查询结果] XXX` - 查询结果
- `[Insert/Update/Delete] 影响行数: X` - 操作影响的行数
- `[等效查询] 参数已设置: X = Y` - 参数设置信息

## 性能优化建议

1. **连接池配置**：服务器使用线程池处理客户端连接
2. **超时设置**：自动清理过期连接和资源
3. **批量操作**：对于大量数据操作，考虑使用批量处理
4. **索引优化**：确保查询条件列有适当的索引

## 安全注意事项

1. **加密传输**：敏感数据在传输过程中会被加密
2. **参数绑定**：使用PreparedStatement防止SQL注入
3. **权限控制**：确保数据库用户只有必要的权限
4. **网络安全**：在生产环境中使用防火墙保护服务器端口

## 故障排除

### 启动问题

1. **端口被占用**：修改启动端口
   ```bash
   java -Dport=8888 -jar jdbc-proxy-core-0.2.0-SNAPSHOT-jar-with-dependencies.jar
   ```

2. **Java版本问题**：确保使用Java 8或更高版本
   ```bash
   java -version
   ```

### 连接问题

1. **检查服务器状态**：确认服务器正在监听指定端口
2. **网络连通性**：使用telnet测试端口连通性
   ```bash
   telnet localhost 9999
   ```

3. **防火墙设置**：确保防火墙允许指定端口的通信

### 数据库问题

1. **连接测试**：直接连接数据库测试连接信息
2. **权限检查**：确认数据库用户有足够的权限
3. **表结构**：确认目标表存在且结构正确

## 联系支持

如遇到问题，请提供以下信息：
- 错误日志
- 使用的命令
- 环境信息（操作系统、Java版本等）
- 数据库版本和配置


